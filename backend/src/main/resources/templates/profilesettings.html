<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<div class="max-w-3xl mx-auto px-4 py-10 space-y-8">

  <!-- Profile Overview -->
  <div class="bg-white rounded-xl shadow-md p-8 text-center">

    <img src="https://i.pravatar.cc/200"
         alt="User avatar"
         class="w-32 h-32 rounded-full mx-auto object-cover shadow">

    <h1 th:text="${user.name}" class="text-3xl font-bold mt-4">John Doe</h1>
    <p th:text="${user.email}" class="text-gray-600 mt-1">john.doe@example.com</p>

  </div>

  <!-- GOOGLE ACCOUNT INFO -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4">Google Account Info</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

      <div class="p-4 bg-gray-50 rounded-lg border">
        <p class="text-gray-500 text-sm">Full Name</p>
        <p th:text="${user.name}" class="font-medium">John Doe</p>
      </div>

      <div class="p-4 bg-gray-50 rounded-lg border">
        <p class="text-gray-500 text-sm">Email</p>
        <p th:text="${user.email}" class="font-medium">john.doe@example.com</p>
      </div>

      <div class="p-4 bg-gray-50 rounded-lg border">
        <p class="text-gray-500 text-sm">Google ID</p>
        <p th:text="${user.id}" class="font-medium">112938475612837465</p>
      </div>

      <div class="p-4 bg-gray-50 rounded-lg border">
        <p class="text-gray-500 text-sm">Provider</p>
        <p th:text="${user.provider}" class="font-medium">Yes</p>
      </div>
    </div>
  </div>

  <!-- PROFILE EDIT FORM -->
  <form th:action="@{/profilesettings}" method="post" th:object="${user}">
    <div class="bg-white rounded-xl shadow-md p-6 mb-4">
      <h2 class="text-xl font-semibold mb-4">About yourself</h2>
      <div class="p-2">
        <label for="display-name" class="block font-medium mb-1">Display Name</label>
        <input type="text"
               id="display-name"
               th:field="*{displayName}"
               placeholder="Change your display name here!"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="p-2">
        <label for="display-city" class="block font-medium mb-1">City</label>
        <input type="text"
               id="display-city"
               th:field="*{city}"
               placeholder="Enter your city here!"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="space-y-4">
        <div class="p-2">
          <label for="bio" class="block font-medium mb-1">Your Bio</label>
          <textarea
            id="bio"
            th:field="*{bio}"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-32 resize-none"
            placeholder="Write something about yourself..."></textarea>
        </div>
        <button type="submit"
                class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold shadow transition w-full sm:w-auto">
          Save Settings
        </button>
      </div>
    </div>
  </form>

  <!-- SECURITY CARD -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4">Security</h2>

    <button
      id="add-passkey-btn"
      class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold shadow transition w-full sm:w-auto">
      Add Passkey
    </button>

    <p class="text-sm text-gray-500 mt-3">
      Passkeys let you log in using biometrics or device credentials.
    </p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4">Your Reports</h2>

    <div th:if="${#lists.isEmpty(reports)}">
      <p class="text-gray-500">You haven't submitted any reports yet.</p>
    </div>

    <ul th:unless="${#lists.isEmpty(reports)}" class="space-y-4">
      <li th:each="report : ${reports}" class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border">
        <div>
          <p class="font-medium" th:text="${report.description}">Report Description</p>

          <p class="text-gray-500 text-sm">
            Submitted:
            <span th:text="${#temporals.format(report.submittedAt, 'yyyy-MM-dd')}">2025-01-01</span>
            <span class="ml-2 px-2 py-0.5 text-xs rounded bg-blue-100 text-blue-800"
                  th:text="${report.eventType}">
            TYPE
          </span>
          </p>
        </div>

        <form th:action="@{/profilesettings/reports/{id}/delete(id=${report.id})}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">Delete</button>
        </form>
      </li>
    </ul>
  </div>


</div>

<script>
  // din befintliga JS för passkeys – orörd
  function base64urlToUint8Array(base64url) {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const pad = '='.repeat((4 - (base64.length % 4)) % 4);
    const binary = atob(base64 + pad);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes;
  }

  function uint8ArrayToBase64url(bytes) {
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    let base64 = btoa(binary);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  }

  async function registerPasskey() {
    if (!window.PublicKeyCredential) {
      alert('Den här webbläsaren stödjer inte passkeys/WebAuthn.');
      return;
    }

    try {
      const optionsRes = await fetch('/webauthn/register/options', {
        method: 'POST'
      });

      if (!optionsRes.ok) {
        console.error('Error fetching registration options', optionsRes.status);
        alert('Kunde inte hämta passkey-inställningar (options).');
        return;
      }

      const optionsJson = await optionsRes.json();

      const publicKey = {
        ...optionsJson,
        challenge: base64urlToUint8Array(optionsJson.challenge),
        user: {
          ...optionsJson.user,
          id: base64urlToUint8Array(optionsJson.user.id)
        },
        excludeCredentials: (optionsJson.excludeCredentials || []).map((cred) => ({
          ...cred,
          id: base64urlToUint8Array(cred.id)
        }))
      };

      const credential = await navigator.credentials.create({ publicKey });

      if (!credential) {
        alert('Ingen passkey skapades.');
        return;
      }

      let credentialJson;
      if (typeof credential.toJSON === 'function') {
        credentialJson = credential.toJSON();
      } else {
        const response = credential.response;
        credentialJson = {
          id: credential.id,
          rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
          type: credential.type,
          response: {
            attestationObject: uint8ArrayToBase64url(new Uint8Array(response.attestationObject)),
            clientDataJSON: uint8ArrayToBase64url(new Uint8Array(response.clientDataJSON)),
            transports: response.getTransports ? response.getTransports() : []
          },
          clientExtensionResults: credential.getClientExtensionResults
            ? credential.getClientExtensionResults()
            : {},
          authenticatorAttachment: credential.authenticatorAttachment
        };
      }

      const registerBody = {
        publicKey: {
          credential: credentialJson,
          label: 'Profile passkey'
        }
      };

      const registerRes = await fetch('/webauthn/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(registerBody)
      });

      if (registerRes.ok) {
        alert('Passkey registrerad!');
      } else {
        const text = await registerRes.text();
        console.error('Register error:', registerRes.status, text);
        alert('Misslyckades att registrera passkey (kolla serverloggarna).');
      }
    } catch (err) {
      console.error(err);
      alert('Ett fel uppstod vid passkey-registrering: ' + err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('add-passkey-btn');
    if (!btn) return;
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      registerPasskey();
    });
  });
</script>

</body>
</html>
